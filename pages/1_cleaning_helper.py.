import streamlit as st
from openai import OpenAI
import base64

st.set_page_config(page_title="ğŸ§¹ ì§‘ì•ˆ ì²­ì†Œ í•´ê²°ì‚¬")

st.title("ğŸ§¹ ì§‘ì•ˆ ì²­ì†Œ í•´ê²°ì‚¬")
st.write("ì§‘ì•ˆ ì²­ì†Œê°€ ê³ ë¯¼ë˜ë©´ ì‚¬ì§„ì„ ì´¬ì˜í•˜ê±°ë‚˜ ì§ˆë¬¸ì„ ì…ë ¥í•´ ë³´ì„¸ìš”!")

# OpenAI client (ì´ë¯¸ ë©”ì¸ì—ì„œ ì„¸ì…˜ì— ì €ì¥ë¨)
client = st.session_state.get('openai_client', None)

# í˜¹ì‹œ ëª¨ë¥¼ None ë°©ì§€ìš©
if client is None:
    st.error("âš ï¸ OpenAI í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í™”ë©´ì—ì„œ API Keyë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    st.stop()


# -------------------------------
# ë©”ì‹œì§€ ë Œë”ë§ í•¨ìˆ˜
# -------------------------------
def show_message(msg):
    st.chat_message(msg["role"]).write(msg["content"])


# -------------------------------
# ì„¸ì…˜ ì´ˆê¸°í™”
# -------------------------------
if "clean_messages" not in st.session_state:
    st.session_state.clean_messages = [
        {
            "role": "system",
            "content": (
                "ë„ˆëŠ” 1ì¸ ê°€êµ¬ ì²­ì†Œ ì „ë¬¸ê°€ AIì•¼. "
                "ì‚¬ìš©ìê°€ ë³´ë‚´ëŠ” ì‚¬ì§„(ì—ì–´ì»¨ í•„í„°, í™”ì¥ì‹¤, ë³´ì¼ëŸ¬, ê³°íŒ¡ì´, ì‹±í¬ëŒ€ ë“±)ì„ ê¸°ë°˜ìœ¼ë¡œ "
                "í˜„ì¬ ìƒíƒœë¥¼ ë¶„ì„í•˜ê³ , ì²­ì†Œ ë‚œì´ë„ì™€ ìœ„í—˜ ìš”ì†Œë¥¼ ì„¤ëª…í•œ ë’¤, "
                "1) ì§€ê¸ˆ í•´ì•¼ í•  ìš°ì„  ì¡°ì¹˜ "
                "2) í•„ìš”í•œ ì¤€ë¹„ë¬¼(ìµœëŒ€í•œ ì§‘ì— ìˆì„ ë§Œí•œ ê²ƒ ìœ„ì£¼) "
                "3) ë‹¨ê³„ë³„ ì²­ì†Œ ë°©ë²• "
                "4) ì£¼ì˜ì‚¬í•­ "
                "5) ì „ë¬¸ê°€ë¥¼ ë¶ˆëŸ¬ì•¼ í•˜ëŠ” ìƒí™© ì—¬ë¶€ "
                "ë¥¼ ê°„ë‹¨í•˜ê³  ì°¨ë¶„í•˜ê²Œ ì„¤ëª…í•´. "
                "ì‚¬ì§„ì´ ì—†ìœ¼ë©´ í…ìŠ¤íŠ¸ë§Œìœ¼ë¡œë„ ìµœëŒ€í•œ ë„ì›€ì„ ì¤˜."
            )
        }
    ]


# -------------------------------
# ì‚¬ì§„ ì…ë ¥ (ë²„íŠ¼ìœ¼ë¡œ ì„ íƒ)
# -------------------------------
st.subheader("1) ì‚¬ì§„ì€ ì„ íƒì´ì—ìš”")
use_camera = st.checkbox("ğŸ“· ì¹´ë©”ë¼ë¡œ ì°ì–´ì„œ ë³´ë‚´ê¸°")

image = None
if use_camera:
    image = st.camera_input("ì²­ì†Œê°€ í•„ìš”í•œ ë¶€ë¶„ì„ ì´¬ì˜í•´ ì£¼ì„¸ìš”")


# -------------------------------
# ê¸°ì¡´ ëŒ€í™” ì¶œë ¥
# -------------------------------
for msg in st.session_state.clean_messages:
    if msg["role"] != "system":
        show_message(msg)


# -------------------------------
# í…ìŠ¤íŠ¸ ì…ë ¥
# -------------------------------
prompt = st.chat_input("ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?")

if prompt:
    # ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ + ì¶œë ¥
    user_msg = {"role": "user", "content": prompt}
    st.session_state.clean_messages.append(user_msg)
    show_message(user_msg)

    # content_list êµ¬ì„± (í…ìŠ¤íŠ¸ + ì´ë¯¸ì§€)
    content_list = [{"type": "input_text", "text": prompt}]

    if image:
        img_b64 = base64.b64encode(image.getvalue()).decode()
        content_list.append({
            "type": "input_image",
            "image_url": f"data:image/jpeg;base64,{img_b64}"
        })

    # -------------------------------
    # Responses API í˜¸ì¶œ
    # -------------------------------
    try:
        with st.chat_message("assistant"):
            with st.spinner("ì²­ì†Œ ë°©ë²•ì„ ê³ ë¯¼ ì¤‘ì´ì—ìš”..."):
                response = client.responses.create(
                    model="gpt-4.1-mini",  # gpt-4.1ë„ ê°€ëŠ¥, miniê°€ ë” ë¹ ë¦„
                    input=[
                        # system í”„ë¡¬í”„íŠ¸ 1ê°œë§Œ ì¨ë„ ì¶©ë¶„í•´ì„œ ì´ë ‡ê²Œ ë‹¨ìˆœí™”
                        {
                            "role": "system",
                            "content": st.session_state.clean_messages[0]["content"],
                        },
                        {
                            "role": "user",
                            "content": content_list,
                        },
                    ],
                )

                assistant_reply = response.output_text
                st.write(assistant_reply)

        # assistant ë©”ì‹œì§€ ì €ì¥
        assistant_msg = {"role": "assistant", "content": assistant_reply}
        st.session_state.clean_messages.append(assistant_msg)

    except Exception as e:
        # ì—ëŸ¬ë¥¼ í™”ë©´ì— ë³´ì—¬ì£¼ê¸°
        st.error(f"âš ï¸ OpenAI ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: {e}")